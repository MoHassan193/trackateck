import 'dart:async';
import 'dart:convert';
import 'package:dio/dio.dart';
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:visit_man/model/userModel/userModel.dart';
import 'dart:math';
import 'package:intl/intl.dart';

import '../../../../../model/dialToast.dart';
import '../reschudleAndCancelWidget/ReschudleAndCancelWidget.dart';


class StartTimer extends StatefulWidget {
  const StartTimer({
    Key? key, required this.partnerData, required this.visitId,required this.state
  }) : super(key: key);
  final Map<String, dynamic> partnerData;
  final int visitId;
  final String state;




  @override
  State<StartTimer> createState() => _StartTimerState();
}

class _StartTimerState extends State<StartTimer> {
  bool _canStartVisit = false;
  bool _deactivateLocation = false; // New variable for DeActivate Location
  bool _checkedIn = false;
  bool _visitEnded = false;
  DateTime? _checkInTime;
  DateTime? _checkOutTime;
  Timer? _timer;
  int _seconds = 0;
  late UserModel userModel;
  DateTime now = DateTime.now();
  bool visitCompleted = false; // متغير للتحكم في إظهار الأزرار

  Future<void> _refreshData() async {
    // Perform your data refresh actions
    await _checkLocationMatch();
    await loadUserModel();
    await _checkVisitCompletion();

    // This will update the UI with the new data
    setState(() {
      // Here you could also modify other variables if needed
      // e.g., _canStartVisit, visitCompleted, etc.
    });
  }

  @override
  void initState() {
    super.initState();
    _checkLocationMatch();
    loadUserModel();
    _loadVisitData();
    _checkVisitCompletion();  // Add this check
    _canStartVisit = widget.partnerData['check_location'] == false ? true : false;
   _checkScheduledCheckOut();
  }

  @override
  void dispose() {
    _timer?.cancel(); // Cancel the timer when the widget is disposed
    super.dispose();
  }

  double _calculateDistance(double lat1, double lon1, double lat2, double lon2) {
    const double R = 6371000; // Earth's radius in meters
    double dLat = _degreeToRadian(lat2 - lat1);
    double dLon = _degreeToRadian(lon2 - lon1);

    double a = sin(dLat / 2) * sin(dLat / 2) +
        cos(_degreeToRadian(lat1)) * cos(_degreeToRadian(lat2)) *
            sin(dLon / 2) * sin(dLon / 2);
    double c = 2 * atan2(sqrt(a), sqrt(1 - a));

    return R * c; // Distance in meters
  }

  double _degreeToRadian(double degree) {
    return degree * pi / 180;
  }

  Future<void> _checkLocationMatch() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();

    // استرجاع إحداثيات الشريك والموقع الحالي من SharedPreferences
    double? partnerLatitude = widget.partnerData['partner_latitude'];
    double? partnerLongitude = widget.partnerData['partner_longitude'];
    double? currentLatitude = prefs.getDouble('latitude');
    double? currentLongitude = prefs.getDouble('longitude');

    // إذا كان check_location = false، اجعل canStartVisit = true مباشرة
    if (widget.partnerData['check_location'] == false) {
      setState(() {
        _canStartVisit = true;
      });
      return;
    }

    // إذا كان check_location = true، تحقق من المسافة
    if (partnerLatitude != null &&
        partnerLongitude != null &&
        currentLatitude != null &&
        currentLongitude != null) {
      double distance = _calculateDistance(
          partnerLatitude, partnerLongitude, currentLatitude, currentLongitude);

      if (distance < 500) {
        setState(() {
          _canStartVisit = true;
        });
      } else {
        setState(() {
          _canStartVisit = false;
        });
      }
    } else {
      setState(() {
        _canStartVisit = false;
      });
    }
  }

  void _startTimer() {
    _timer = Timer.periodic(Duration(seconds: 1), (Timer timer) {
      setState(() {
        _seconds++;
      });
    });
  }

  void _stopTimer() {
    _timer?.cancel();
  }

  String _formatTime() {
    int minutes = _seconds ~/ 60;
    int seconds = _seconds % 60;
    return '${minutes.toString().padLeft(2, '0')}:${seconds.toString().padLeft(2, '0')}';
  }


  void _loadVisitData() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();

    // قراءة check-in status
    bool? checkInStatus = prefs.getBool('checkin_${widget.visitId}');
    if (checkInStatus != null && checkInStatus) {
      setState(() {
        _checkedIn = checkInStatus;
        _checkInTime = DateTime.parse(prefs.getString('visit_${widget.visitId}_checkInTime')!);
        Duration elapsedTime = DateTime.now().difference(_checkInTime!);
        _seconds = elapsedTime.inSeconds;
        // تشغيل المؤقت

        _startTimer();
      });
    }

    // قراءة check-out status
    bool? visitEnded = prefs.getBool('visitEnded_${widget.visitId}');
    if (visitEnded != null && visitEnded) {
      setState(() {
        _visitEnded = visitEnded;
        _checkOutTime = DateTime.parse(prefs.getString('visit_${widget.visitId}_checkOutTime')!);
      });
    }
  }


  void _checkIn() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();

    String visitKey = 'visit_${widget.visitId}_checkInTime';
    bool checkInValue = true;

    // حفظ checkinVisitId كـ true
    await prefs.setBool('checkin_${widget.visitId}', checkInValue);

    setState(() {
      _checkedIn = checkInValue;
      _checkInTime = DateTime.now(); // استخدام الوقت الحالي كوقت Check-In
      _seconds = 0; // إعادة ضبط التايمر
    });

    // بدء التايمر
    _startTimer();

    // حفظ البيانات في SharedPreferences
    await prefs.setString('inDoom${widget.visitId}', 'True');
    await prefs.setString('state${widget.visitId}', 'done');
    await prefs.setString(visitKey, _checkInTime.toString());
    await prefs.setBool('Checked_${widget.visitId}_Done',true );
  }


  void _checkOut() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    String checkOutKey = 'visit_${widget.visitId}_checkOutTime';



    setState(() {
      _checkOutTime = DateTime.now(); // استخدام الوقت الحالي كوقت Check-Out
      _checkedIn = false;
    });

    // إيقاف التايمر
    _stopTimer();

    // حساب مدة الزيارة
    Duration visitDuration = _checkOutTime!.difference(_checkInTime!);
    String formattedDuration = '${visitDuration.inMinutes.toString().padLeft(2, '0')}:${(visitDuration.inSeconds % 60).toString().padLeft(2, '0')}';

    // حفظ وقت Check-Out ومدة الزيارة في SharedPreferences باستخدام visitId
    await prefs.setString(checkOutKey, _checkOutTime.toString());
    await prefs.setString('visit_${widget.visitId}_duration', formattedDuration);
    bool visitEndedValue = true;

    // حفظ visitEndedVisitId كـ true
    await prefs.setBool('visitEnded_${widget.visitId}', visitEndedValue);
    // إظهار زر End Visit
    setState(() {
      _visitEnded = visitEndedValue;
    });
    await prefs.setBool('visit_${widget.visitId}Ended', _visitEnded);

    await endAndUpdateVisit();


    // // عرض رسالة توست تحتوي على وقت Check-In وCheck-Out والمدة
    // DialToast.showToast(
    //     "Check In At: ${DateFormat('yyyy-MM-dd HH:mm:ss').format(_checkInTime!)} \n"
    //         "Check Out At: ${DateFormat('yyyy-MM-dd HH:mm:ss').format(_checkOutTime!)} \n"
    //         "Duration: $formattedDuration",
    //     Colors.green
    // );
  }

  void _checkScheduledCheckOut() async {
    final prefs = await SharedPreferences.getInstance();
    bool isCheckedDone = prefs.getBool('checkin_${widget.visitId}') ?? false;

    if (isCheckedDone || !visitCompleted) {
        _checkTimeAndAutoCheckOut();
    }
  }

  void _checkTimeAndAutoCheckOut() async {
    final now = DateTime.now();
    if (now.hour == 20 && now.minute == 0 && now.second == 0) {
       _checkOut(); // استدعاء الدالة تلقائياً
      _timer?.cancel(); // إلغاء المؤقت بعد الخروج
    }
  }

  Future<void> loadUserModel() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final sessionData = prefs.getString('sessionData');
      if (sessionData != null) {
        userModel = UserModel.fromJson(jsonDecode(sessionData));
      } else {
        throw Exception('No user data found');
      }
    } catch (e) {
      print(e);
    }
  }


  Future<void> endAndUpdateVisit() async {

    await loadUserModel();

    try{

    // print(userModel.accessToken);

    final prefs = await SharedPreferences.getInstance();
    // Read stored values from SharedPreferences
    String? inDoom = prefs.getString('inDoom${widget.visitId}');
    String? state = prefs.getString('state${widget.visitId}');


    // Ensure values were retrieved successfully

    final dio = Dio();
    final String? url = prefs.getString('storedUrl'); // Get the API URL

    if (url == null || url.isEmpty) {
      print('Error: URL not found in SharedPreferences');
      DialToast.showToast('Failed to end visit', Colors.red);
      return;
    }


// Retrieve the stored duration time
      final durationTimeString = await prefs.getString('visit_${widget.visitId}_duration');
      Duration durationTime = Duration.zero;
      if (durationTimeString != null) {
        durationTime = Duration(hours: int.parse(durationTimeString.split(':')[0]), minutes: int.parse(durationTimeString.split(':')[1]));
      }

// Check if the duration time is more than two hours
      if (durationTime > Duration(hours: 2)) {
        // Set check-out time to two hours after check-in
        _checkOutTime = _checkInTime!.add(Duration(hours: 2));
      }

      final request = {
        'in_doom': '"$inDoom"',
        'check_in': DateFormat('yyyy-MM-dd HH:mm:ss').format(_checkInTime!),
        'check_out': DateFormat('yyyy-MM-dd HH:mm:ss').format(_checkOutTime!),
        'state': state,
        'rank_id': null,
        'behave_style_id': null,
        'segment_id': null,
        'classification_id': null,
        'no_patient': null,
        'survey_id': null,
        'client_attitude': null,
      };


    final response = await dio.post(
      '$url/api/${widget.visitId}/update_visit',
      options: Options(
        contentType: Headers.formUrlEncodedContentType,
        headers: {
          'token': userModel.accessToken
        },
      ),
      data: request,
    );

    // Check the response status
    if (response.statusCode == 200) {
      final data = response.data['data'];
      final inDoom = data['in_doom'];
      final checkIn = data['check_in'];
      final checkOut = data['check_out'];
      final state = data['state'];
      final clientAttitude = data['client_attitude'];


      DialToast.showToast(
          "Visit updated successfully\n\n"
              "Check In At : $checkIn \nCheck Out At : $checkOut"
              "In Doom : $inDoom \nState : $state \nClient Attitude : $clientAttitude",
          Colors.green);
      Navigator.pop(context);
      // Resetting the state of the page
      setState(() {
        _canStartVisit = false;
        _checkedIn = false;
        _visitEnded = false;
        visitCompleted = true;
      });
    } else {
      DialToast.showToast("Failed to update visit", Colors.red);
     }
    }catch(e){
      DialToast.showToast(
          "Visit updated successfully",
          Colors.green);
      Navigator.pop(context);
      // Resetting the state of the page
      setState(() {
        _canStartVisit = false;
        _checkedIn = false;
        _visitEnded = false;
        visitCompleted = true;
      });
    }
  }

  Future<void> _checkVisitCompletion() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    String checkOutKey = 'visit_${widget.visitId}_checkOutTime';

    // Check if the Check-Out key exists in SharedPreferences
    if (!prefs.containsKey(checkOutKey)) {
      setState(() {
        visitCompleted = true;  // No Check-Out exists, set visitCompleted to true
        prefs.setBool('visit_${widget.visitId}_completed', visitCompleted);
      });
    } else {
      setState(() {
        visitCompleted = false;  // Check-Out exists, keep visit in progress
      });
    }
  }


  @override
  Widget build(BuildContext context) {
    return RefreshIndicator(
        onRefresh: _refreshData,  // This function will be called on pull-to-refresh
        child: visitCompleted
            ? Column(
      children: [
        ReschudleAndCancelWidget(
          visitId: widget.visitId.toString(),
          state: widget.state,
        ),
        SizedBox(height:   5,),
        // تعديل SwitchListTile
        SwitchListTile(
          title: Text('Deactivate Location'),
          value: _deactivateLocation,
          onChanged: (bool value) async {
            setState(() {
              _deactivateLocation = value;
              if (value) {
                _canStartVisit = true;
              } else {
                _checkLocationMatch();
              }
            });
            // حفظ القيمة الجديدة
            await _saveState(value);
          },
          activeColor: Colors.blue,
          activeTrackColor: Colors.blue.withOpacity(0.5),
          inactiveThumbColor: Colors.grey,
          inactiveTrackColor: Colors.black26,
          contentPadding: EdgeInsets.symmetric(horizontal: 16),
          tileColor: _deactivateLocation ? Colors.blue.withOpacity(0.1) : Colors.grey.shade200,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
        ),        SizedBox(height:   5,),
        if (_canStartVisit || _deactivateLocation)
          _checkedIn
              ? Container(
            decoration: BoxDecoration(
              color: Colors.white, // لون الخلفية
              borderRadius: BorderRadius.circular(10),
              border: Border.all(color: Colors.cyan, width: 2),
            ),
            padding: EdgeInsets.all(20),
            margin: EdgeInsets.all(15),
            child: Column(
              children: [
                Text(
                  'Check-In Time: ${DateFormat('yyyy-MM-dd HH:mm:ss').format(_checkInTime!)}',
                  style: TextStyle(fontSize: 14, color: Colors.black),
                ),
                Text(
                  'Elapsed Time: ${_formatTime()}',
                  style: TextStyle(fontSize: 18, color: Colors.blue),
                ),
                SizedBox(height: 20),
                SizedBox(
                  width: MediaQuery.of(context).size.width * 0.4,
                  child: OutlinedButton(
                    onPressed: _checkOut, // Stop the timer and register check-out
                    child: const Text(
                      "Check-Out & End Visit",
                      textAlign: TextAlign.center,
                      style: TextStyle(color: Colors.blue,fontSize:12),
                    ),
                  ),
                ),
                if (_checkOutTime != null)
                  Text(
                    'Check-Out Time: ${DateFormat('yyyy-MM-dd HH:mm:ss').format(_checkOutTime!)}',
                    style: TextStyle(fontSize: 16, color: Colors.black),
                  ),
              ],
            ),
          ) : Column(
            mainAxisAlignment: MainAxisAlignment.spaceEvenly,
            children: [
              if (!_visitEnded)
                SizedBox(
                width: MediaQuery.of(context).size.width * 0.4,
                child: ElevatedButton(
                  onPressed: _checkIn, // Register check-in and start the timer
                  child: const Text(
                    "Check-In",
                    style: TextStyle(color: Colors.black),
                  ),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.white,
                  ),
                ),
              ),
              SizedBox(height: 10),
              // if (_visitEnded)
              //   SizedBox(
              //     width: MediaQuery.of(context).size.width * 0.4,
              //     child: OutlinedButton(
              //       onPressed: () async {
              //       },
              //       child: const Text(
              //         "End Visit",
              //         style: TextStyle(color: Colors.white),
              //       ),
              //       style: ElevatedButton.styleFrom(
              //         backgroundColor: Colors.red,
              //       ),
              //     ),
              //   ),
            ],
          )
        else
          Column(
            children: [
              SizedBox(height: 10),
              SizedBox(
                width: MediaQuery.of(context).size.width * 0.4,
                child: OutlinedButton(
                  onPressed: () {
                    DialToast.showToast(
                      "You are not in Location,\nplease check your location",
                      Colors.red,
                    );
                  },
                  child: Text(
                    "Check In",
                    style: TextStyle(color: Colors.white),
                  ),
                  style: OutlinedButton.styleFrom(
                    backgroundColor: Colors.red,
                  ),
                ),
              ),
            ],
          ),
      ],
    ) : SizedBox(
          width: MediaQuery.of(context).size.width * 0.4,
          child: OutlinedButton(onPressed: () {
            DialToast.showToast(
              "Visit Completed",Colors.green
            );
          } , child: Text("Visit Done")))
    );
  }
}
